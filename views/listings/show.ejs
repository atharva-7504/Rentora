<% layout("/layouts/boilerplate.ejs") %>

<style>
  :root {
    --primary: #ff385c;
    --dark: #222222;
    --gray: #717171;
    --platinum: #f8f9fa;
    --shadow: 0 12px 24px rgba(0,0,0,0.08);
  }

  .premium-container {
    max-width: 1100px;
    margin: 2rem auto;
    padding: 0 1.5rem;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
  }

  /* Header Section */
  .listing-header h2 { font-weight: 800; color: var(--dark); font-size: 2rem; margin-bottom: 0.5rem; }
  .listing-meta { display: flex; gap: 1rem; color: var(--gray); font-weight: 500; font-size: 0.95rem; margin-bottom: 1.5rem; }

  /* Hero Image */
  .hero-box {
    width: 100%; height: 500px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: var(--shadow);
    margin-bottom: 2.5rem;
  }
  .hero-box img { width: 100%; height: 100%; object-fit: cover; transition: 0.6s ease; }

  /* Main Responsive Grid */
  .main-grid {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 3.5rem;
  }

  /* Left Column: Narrative & Services */
  .host-profile {
    display: flex; align-items: center; gap: 1rem;
    padding-bottom: 1.5rem; border-bottom: 1px solid #eee; margin-bottom: 2rem;
  }
  .avatar-mock {
    width: 52px; height: 52px; background: var(--dark);
    color: white; border-radius: 50%; display: flex;
    align-items: center; justify-content: center; font-weight: 700;
  }
  .description-text { font-size: 1.1rem; line-height: 1.8; color: #484848; margin-bottom: 2rem; }

  .services-section {
    margin-top: 3rem; padding: 2rem;
    background: #ffffff; border-radius: 20px; border: 1px solid #eee;
  }
  .services-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 2rem; margin-top: 1.5rem;
  }
  .service-card h6 { font-weight: 700; margin-bottom: 0.5rem; }
  .service-card i { color: var(--primary); font-size: 1.4rem; margin-bottom: 0.8rem; display: block; }

  /* Right Column: Information Sidebar (No Reserve) */
  .sidebar-card {
    position: sticky; top: 100px;
    padding: 2rem; border-radius: 20px;
    border: 1px solid #ddd; background: white;
    box-shadow: var(--shadow); height: fit-content;
  }
  .price-large { font-size: 1.8rem; font-weight: 800; color: var(--dark); margin-bottom: 0.5rem; }
  
  .trust-badge-list { list-style: none; padding: 0; margin: 1.5rem 0; }
  .trust-badge-list li { display: flex; gap: 12px; margin-bottom: 18px; font-size: 0.95rem; line-height: 1.4; }
  .trust-badge-list i { font-size: 1.2rem; color: var(--dark); margin-top: 3px; }

  /* Admin Buttons */
  .btn-action {
    display: block; width: 100%; padding: 14px;
    border-radius: 12px; font-weight: 700; text-align: center;
    text-decoration: none; transition: 0.3s;
  }
  .btn-edit { background: var(--dark); color: white !important; margin-bottom: 10px; }
  .btn-delete { background: transparent; color: #dc3545; border: 2px solid #dc3545; }
  .btn-contact { background: #f0f0f0; color: var(--dark); border: none; font-weight: 600; }
  
  /* Review Section */
  .review-box { background: var(--platinum); border-radius: 20px; padding: 2.5rem; margin: 3rem 0; }
  .review-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
  .review-card { background: white; border-radius: 15px; padding: 1.5rem; border: 1px solid #eee; }

  

  /* Mobile Overrides */
  @media (max-width: 991px) {
    .main-grid { grid-template-columns: 1fr; }
    .hero-box { height: 350px; border-radius: 0; margin: 0 -1.5rem 2rem -1.5rem; width: calc(100% + 3rem); }
    .sidebar-card { position: static; margin-bottom: 2.5rem; }
    .services-grid { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 576px) { .services-grid { grid-template-columns: 1fr; } }
</style>

<div class="premium-container">
  <div class="listing-header">
    <h2><%= listing.title %></h2>
    <div class="listing-meta">
      <span><i class="fa-solid fa-medal text-danger"></i> Highly Rated Space</span>
      <span>•</span>
      <span class="text-decoration-underline fw-bold"><%= listing.location %>, <%= listing.country %></span>
    </div>
  </div>

  <div class="hero-box">
    <img src="<%= listing.image.url %>" alt="Listing Image">
  </div>

  <div class="main-grid">
    <div class="content-left">
      <div class="host-profile">
        <div class="avatar-mock"><%= listing.owner.username[0].toUpperCase() %></div>
        <div>
          <h5 class="m-0 fw-bold">Hosted by <%= listing.owner.username %></h5>
          <span class="text-muted small">Trusted Host · Verified Member</span>
        </div>
      </div>

      <p class="description-text"><%= listing.description %></p>

      <div class="services-section">
        <h5 class="fw-bold mb-1">Services we provide</h5>
        <p class="text-muted small mb-4">Trusted details for a premium stay</p>
        <div class="services-grid">
          <div class="service-card">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            <h6>Daily Cleaning</h6>
            <p>On-demand professional housekeeping to keep your stay fresh.</p>
          </div>
          <div class="service-card">
            <i class="fa-solid fa-headset"></i>
            <h6>Local Concierge</h6>
            <p>Get insider tips and help with local bookings 24/7.</p>
          </div>
          <div class="service-card">
            <i class="fa-solid fa-wifi"></i>
            <h6>Ultra Fast Fiber</h6>
            <p>Stay connected with high-speed internet in every room.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="content-sidebar">
      <div class="sidebar-card">
        <div class="price-large">&#8377;<%= listing.price.toLocaleString("en-IN") %></div>
        <p class="text-muted small border-bottom pb-3">Total per night (inclusive of all taxes)</p>

        <ul class="trust-badge-list">
          <li><i class="fa-solid fa-circle-check"></i> <span><b>Verified Property</b><br>This home has been inspected for quality.</span></li>
          <li><i class="fa-solid fa-calendar-check"></i> <span><b>Flexible Policy</b><br>Free cancellation for the first 24 hours.</span></li>
        </ul>

        <% if(currentUser && listing.owner._id.equals(currentUser._id)) { %>
          <a href="/listings/<%=listing._id%>/edit" class="btn-action btn-edit">Edit Property</a>
          <form action="/listings/<%=listing._id%>?_method=DELETE" method="POST">
            <button class="btn-action btn-delete">Remove Listing</button>
          </form>
        <% } else { %>
          
          <p class="text-center small text-muted mt-3 mb-0">Identity verified via secure portal</p>
        <% } %>
      </div>
    </div>
  </div>

  <hr class="my-5">

  <div class="review-section">
    <h3 class="fw-bold mb-4">Guest Experience</h3>

    <% if(currentUser) { %>
      <div class="review-box shadow-sm">
        <h5 class="fw-bold mb-4">Share your thoughts</h5>
        <form action="/listings/<%= listing._id%>/reviews" method="POST" class="needs-validation" novalidate>
          
          <fieldset class="starability-slot">
            <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
            <input type="radio" id="first-rate1" name="review[rating]" value="1" />
            <label for="first-rate1" title="Terrible">1 star</label>
            <input type="radio" id="first-rate2" name="review[rating]" value="2" />
            <label for="first-rate2" title="Not good">2 stars</label>
            <input type="radio" id="first-rate3" name="review[rating]" value="3" />
            <label for="first-rate3" title="Average">3 stars</label>
            <input type="radio" id="first-rate4" name="review[rating]" value="4" />
            <label for="first-rate4" title="Very good">4 stars</label>
            <input type="radio" id="first-rate5" name="review[rating]" value="5" />
            <label for="first-rate5" title="Amazing">5 stars</label>
          </fieldset>

          <div class="mt-4">
            <label for="comment" class="form-label fw-bold small">Comment</label>
            <textarea id="comment" name="review[comment]" rows="4" class="form-control rounded-4 border-0 shadow-sm p-3" required></textarea>
          </div>
          <button class="btn btn-action btn-edit mt-4 w-auto px-5">Submit Review</button>
        </form>
      </div>
    <% } %>

    <% if(listing.reviews.length > 0) { %>
      <div class="review-grid">
        <% for(review of listing.reviews){ %>
          <div class="review-card shadow-sm">
            <div class="d-flex align-items-center gap-2 mb-2">
                <div class="avatar-mock" style="width:30px; height:30px; font-size:0.7rem;"><%= review.author.username[0] %></div>
                <span class="fw-bold small">@<%= review.author.username %></span>
            </div>
            <p class="starability-result mb-3" data-rating="<%= review.rating %>"></p>
            <p class="text-muted small"><%= review.comment %></p>
            <% if(currentUser && review.author._id.equals(currentUser._id)) { %> 
                <form action="/listings/<%= listing._id %>/reviews/<%= review._id%>?_method=DELETE" method="POST">
                  <button class="btn btn-sm text-danger p-0 fw-bold border-0 bg-transparent" style="font-size:0.7rem">DELETE</button>
                </form>
            <% } %>
          </div>
        <% } %>
      </div>
    <% } %>
  </div>

  <h4 class="fw-bold mb-3">Where you'll be</h4>
  <div id="map" style="height: 400px; width: 100%; border-radius: 20px; border: 1px solid #ddd; overflow: hidden;">
    <iframe width="100%" height="400" src="https://www.openstreetmap.org/export/embed.html?bbox=73.84,18.51,73.88,18.53&layer=mapnik"></iframe>
  </div>
</div>

<script>
  const locationName = "<%= listing.location %>, <%= listing.country %>";
  async function loadMap() {
    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}`);
      const data = await response.json();
      if (!data || data.length === 0) return;
      const lat = Number(data[0].lat);
      const lng = Number(data[0].lon);
      const map = L.map("map", { scrollWheelZoom: true, dragging: true }).setView([lat, lng], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap" }).addTo(map);
      const redIcon = new L.Icon({
        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        iconSize: [25, 41], iconAnchor: [12, 41]
      });
      L.marker([lat, lng],{ icon: redIcon }).addTo(map).bindPopup(`<b>${locationName}</b>`).openPopup();
    } catch (err) { console.error("Map loading failed", err); }
  }
  loadMap();
</script>